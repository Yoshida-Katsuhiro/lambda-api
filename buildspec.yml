version: 0.2

env:
  variables:
    # å¿…é ˆç’°å¢ƒå¤‰æ•°
    STAGE: "dev"
    AWS_DEFAULT_REGION: "ap-northeast-1"
    VPC_ID: "vpc-0c5c87df6f9cc2d81" # ğŸš¨ ã“ã“ã‚’ã‚ãªãŸã®VPC IDã«ä¿®æ­£ã—ã¦ãã ã•ã„ ğŸš¨
    
    # DBæ¥ç¶šç”¨ãƒ€ãƒŸãƒ¼å¤‰æ•°ï¼ˆserverless.yml ã®è§£æ±ºã«å¿…è¦ï¼‰
    DATABASE_USER: "myuser"
    DATABASE_PASSWORD: "mypassword123"
    DATABASE_NAME: "mydbname"


phases:
  install:
    commands:
      - echo Installing Serverless Framework and dependencies...
      - npm install
      - npm install -g serverless@3
  
  build:
    commands:
      - echo Cleaning up previous deployment artifacts...
      # ä»¥å‰ã®æ‰‹å‹•å‰Šé™¤ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ã€removeã‚’å…ˆã«å®Ÿè¡Œ
      - serverless remove --stage ${STAGE} --region ${AWS_DEFAULT_REGION} --vpc-id ${VPC_ID} --db-user ${DATABASE_USER} --db-password ${DATABASE_PASSWORD} --db-name ${DATABASE_NAME} || true

      - echo Deploying via Serverless Framework...
      # å…¨ã¦ã®å¤‰æ•°ã‚’CLIã§æ¸¡ã—ã€serverless.ymlã®å¤‰æ•°ã‚’è§£æ±ºã•ã›ã‚‹
      - serverless deploy --stage ${STAGE} --region ${AWS_DEFAULT_REGION} --vpc-id ${VPC_ID} --db-user ${DATABASE_USER} --db-password ${DATABASE_PASSWORD} --db-name ${DATABASE_NAME}

# CodePipelineã¸æˆæœç‰©ã‚’æ¸¡ã™å¿…è¦ãŒãªã„ãŸã‚ã€artifactã¯ç©º
artifacts:
  files:
    - '**/*'
  discard-paths: yes
  base-directory: .