service: node-project

custom:
  # DBのマスターユーザー情報をここで定義。buildspecから渡される
  dbUser: ${env:DATABASE_USER}
  dbPassword: ${env:DATABASE_PASSWORD}

provider:
  name: aws
  runtime: nodejs20.x
  region: ap-northeast-1
  stage: dev
  environment:
    # Lambdaの環境変数として利用
    DATABASE_USER: ${self:custom.dbUser}
    DATABASE_PASSWORD: ${self:custom.dbPassword}
    DATABASE_HOST: { "Fn::GetAtt": ["MyDatabase", "Endpoint.Address"] }
    DATABASE_NAME: ${env:DATABASE_NAME}
  
  # VPC設定はbuildspecからVPC_IDを取得
  vpc:
    securityGroupIds:
      - sg-0c783dc1db068f8db # 👈 既存のLambda用セキュリティグループID
    subnetIds:
      - subnet-0823a713c079e31aa
      - subnet-0b0698f06dfeac23b
      - subnet-0da4b96f159885f74

functions:
  app:
    handler: app.handler
    events:
      - http:
          path: /{proxy+}
          method: any
          cors: true
          authorizer: aws_iam
      - http:
          path: /products
          method: post
          cors: true
          authorizer: aws_iam
      - http:
          path: /products/{id}
          method: delete
          cors: true
          authorizer: aws_iam

resources:
  Resources:
    # 💡 データベースインスタンスの定義
    MySecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Security group for RDS allowing access from Lambda
        VpcId: ${env:VPC_ID} # 👈 buildspecから渡されるVPC_IDを参照
        SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: 3306
            ToPort: 3306
            SourceSecurityGroupId: sg-0c783dc1db068f8db # 👈 Lambda用のセキュリティグループID

    MyDBSubnetGroup:
      Type: AWS::RDS::DBSubnetGroup
      Properties:
        DBSubnetGroupDescription: Subnets for RDS private access # 👈 前回の修正
        SubnetIds:
          - subnet-0823a713c079e31aa
          - subnet-0b0698f06dfeac23b
          - subnet-0da4b96f159885f74
        DBSubnetGroupName: my-db-subnet-group
        
    MyDatabase:
      Type: AWS::RDS::DBInstance
      Properties:
        Engine: postgres
        DBInstanceClass: db.t3.micro
        MasterUsername: ${self:custom.dbUser}
        MasterUserPassword: ${self:custom.dbPassword}
        AllocatedStorage: 20
        DBName: ${env:DATABASE_NAME}
        DBSubnetGroupName: { Ref: MyDBSubnetGroup }
        
        # 🚨 最終修正点 🚨 参照方法を { Ref: MySecurityGroup } から !Ref MySecurityGroup に変更
        VpcSecurityGroups: 
          - !Ref MySecurityGroup