service: node-project

custom:
  # DBã®ãƒã‚¹ã‚¿ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ã“ã“ã§å®šç¾©ã€‚buildspecã‹ã‚‰æ¸¡ã•ã‚Œã‚‹
  dbUser: ${env:DATABASE_USER}
  dbPassword: ${env:DATABASE_PASSWORD}

provider:
  name: aws
  runtime: nodejs20.x
  region: ap-northeast-1
  stage: dev
  environment:
    # Lambdaã®ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦åˆ©ç”¨
    DATABASE_USER: ${self:custom.dbUser}
    DATABASE_PASSWORD: ${self:custom.dbPassword}
    DATABASE_HOST: { "Fn::GetAtt": ["MyDatabase", "Endpoint.Address"] }
    DATABASE_NAME: ${env:DATABASE_NAME}
  
  # VPCè¨­å®šã¯buildspecã‹ã‚‰VPC_IDã‚’å–å¾—
  vpc:
    securityGroupIds:
      - sg-0c783dc1db068f8db # ğŸ‘ˆ æ—¢å­˜ã®Lambdaç”¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ID
    subnetIds:
      - subnet-0823a713c079e31aa
      - subnet-0b0698f06dfeac23b
      - subnet-0da4b96f159885f74

functions:
  app:
    handler: app.handler
    events:
      - http:
          path: /{proxy+}
          method: any
          cors: true
          authorizer: aws_iam
      - http:
          path: /products
          method: post
          cors: true
          authorizer: aws_iam
      - http:
          path: /products/{id}
          method: delete
          cors: true
          authorizer: aws_iam

resources:
  Resources:
    # ğŸ’¡ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å®šç¾©
    MySecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Security group for RDS allowing access from Lambda
        VpcId: ${env:VPC_ID} # ğŸ‘ˆ buildspecã‹ã‚‰æ¸¡ã•ã‚Œã‚‹VPC_IDã‚’å‚ç…§
        SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: 3306
            ToPort: 3306
            SourceSecurityGroupId: sg-0c783dc1db068f8db # ğŸ‘ˆ Lambdaç”¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ID

    MyDBSubnetGroup:
      Type: AWS::RDS::DBSubnetGroup
      Properties:
        DBSubnetGroupDescription: Subnets for RDS private access # ğŸ‘ˆ å‰å›ã®ä¿®æ­£
        SubnetIds:
          - subnet-0823a713c079e31aa
          - subnet-0b0698f06dfeac23b
          - subnet-0da4b96f159885f74
        DBSubnetGroupName: my-db-subnet-group
        
    MyDatabase:
      Type: AWS::RDS::DBInstance
      Properties:
        Engine: postgres
        DBInstanceClass: db.t3.micro
        MasterUsername: ${self:custom.dbUser}
        MasterUserPassword: ${self:custom.dbPassword}
        AllocatedStorage: 20
        DBName: ${env:DATABASE_NAME}
        DBSubnetGroupName: { Ref: MyDBSubnetGroup }
        
        # ğŸš¨ æœ€çµ‚ä¿®æ­£ç‚¹ ğŸš¨ å‚ç…§æ–¹æ³•ã‚’ { Ref: MySecurityGroup } ã‹ã‚‰ !Ref MySecurityGroup ã«å¤‰æ›´
        VpcSecurityGroups: 
          - !Ref MySecurityGroup