service: node-project

provider:
  name: aws
  runtime: nodejs20.x # Node.jsã®æœ€æ–°LTSãƒãƒ¼ã‚¸ãƒ§ãƒ³
  region: ap-northeast-1
  stage: dev
  environment:
    DATABASE_USER: ${env:DATABASE_USER}
    DATABASE_PASSWORD: ${env:DATABASE_PASSWORD}
    DATABASE_HOST: { "Fn::GetAtt": ["MyDatabase", "Endpoint.Address"] }
    DATABASE_NAME: ${env:DATABASE_NAME}
  vpc:
    securityGroupIds:
      - sg-0c783dc1db068f8db 
    subnetIds:
      - subnet-0823a713c079e31aa
      - subnet-0b0698f06dfeac23b
      - subnet-0da4b96f159885f74


functions:
  app:
    handler: app.handler
    events:
      - http:
          path: /{proxy+}
          method: any
          cors: true
          # private: true ã¯å‰Šé™¤
          authorizer: aws_iam  # â† ã“ã‚Œã‚’è¿½åŠ 

      # POST /products ã®è¨­å®š
      - http:
          path: /products
          method: post
          cors: true
          # private: true ã¯å‰Šé™¤
          authorizer: aws_iam  # â† ã“ã‚Œã‚’è¿½åŠ 

      # DELETE /products/{id} ã®è¨­å®š
      - http:
          path: /products/{id}
          method: delete
          cors: true
          # private: true ã¯å‰Šé™¤
          authorizer: aws_iam  # â† ã“ã‚Œã‚’è¿½åŠ 

      # æ—¢å­˜ã® GET /products ã®è¨­å®šã‚‚åŒæ§˜ã« authorizer: aws_iam ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
resources:
  Resources:
    # ğŸ’¡ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å®šç¾©
    
     MySecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Security group for RDS allowing access from Lambda
        VpcId: vpc-xxxxxxxxxxxxxxxxx # ä»¥å‰æ‰‹å‹•ã§ä½œã£ãŸVPCã®IDã‚’æŒ‡å®š
        SecurityGroupIngress:
          - IpProtocol: tcp             # æ¥ç¶šãƒ—ãƒ­ãƒˆã‚³ãƒ«
            FromPort: 3306             # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒ¼ãƒˆ (MySQLãªã‚‰3306)
            ToPort: 3306               # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒ¼ãƒˆ
            SourceSecurityGroupId: sg-0c783dc1db068f8db # ğŸ‘ˆ è¨±å¯ã—ãŸã„ Lambdaç”¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ID
      
    
    
    
     MyDBSubnetGroup:
       Type: AWS::RDS::DBSubnetGroup
       Properties:
         SubnetIds:
           - subnet-0823a713c079e31aa
           - subnet-0b0698f06dfeac23b
           - subnet-0da4b96f159885f74
         DBSubnetGroupName: my-db-subnet-group
    
    
    
    
     MyDatabase:
       Type: AWS::RDS::DBInstance
       Properties:
         # RDSã®ã‚¨ãƒ³ã‚¸ãƒ³ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚µã‚¤ã‚ºãªã©ã‚’æŒ‡å®š
         Engine: postgres
         DBInstanceClass: db.t3.micro
         MasterUsername: ${env:DATABASE_USER}
         MasterUserPassword: ${env:DATABASE_PASSWORD}
         AllocatedStorage: 20
         # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å (ä»»æ„)
         DBName: ${env:DATABASE_NAME}
         # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã¨ã‚µãƒ–ãƒãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã®è¨­å®šã‚‚å¿…è¦
         # VpcSecurityGroups: 
         #   - { Ref: MySecurityGroup }
         # DBSubnetGroupName: MyDBSubnetGroup      
         DBSubnetGroupName: { Ref: MyDBSubnetGroup }
        