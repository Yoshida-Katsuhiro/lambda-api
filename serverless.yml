service: node-project

custom:
  dbUser: ${env:DATABASE_USER}
  dbPassword: ${env:DATABASE_PASSWORD}

provider:
  name: aws
  runtime: nodejs20.x
  region: ap-northeast-1
  stage: dev
  environment:
    DATABASE_USER: ${self:custom.dbUser}
    DATABASE_PASSWORD: ${self:custom.dbPassword}
    DATABASE_HOST: { "Fn::GetAtt": ["MyDatabase", "Endpoint.Address"] }
    DATABASE_NAME: ${env:DATABASE_NAME}
  
  vpc:
    # 既存のLambda用セキュリティグループIDをそのまま利用
    securityGroupIds:
      - sg-0c783dc1db068f8db 
    subnetIds:
      - subnet-0823a713c079e31aa
      - subnet-0b0698f06dfeac23b
      - subnet-0da4b96f159885f74

functions:
  app:
    handler: app.handler
    events:
      - http:
          path: /{proxy+}
          method: any
          cors: true
          authorizer: aws_iam
      - http:
          path: /products
          method: post
          cors: true
          authorizer: aws_iam
      - http:
          path: /products/{id}
          method: delete
          cors: true
          authorizer: aws_iam

resources:
  Resources:
    # 🚨 削除 🚨 MySecurityGroup リソースは不要なため削除しました。

    MyDBSubnetGroup:
      Type: AWS::RDS::DBSubnetGroup
      Properties:
        DBSubnetGroupDescription: Subnets for RDS private access
        SubnetIds:
          - subnet-0823a713c079e31aa
          - subnet-0b0698f06dfeac23b
          - subnet-0da4b96f159885f74
        DBSubnetGroupName: my-db-subnet-group
        
    MyDatabase:
      Type: AWS::RDS::DBInstance
      Properties:
        Engine: postgres
        DBInstanceClass: db.t3.micro
        MasterUsername: ${self:custom.dbUser}
        MasterUserPassword: ${self:custom.dbPassword}
        AllocatedStorage: 20
        DBName: ${env:DATABASE_NAME}
        DBSubnetGroupName: { Ref: MyDBSubnetGroup }
        
        # 🚨 削除 🚨 VpcSecurityGroupIds プロパティを削除しました。
        # LambdaのVPC設定(providerセクション)に任せます。